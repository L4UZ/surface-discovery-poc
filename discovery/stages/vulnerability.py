"""Vulnerability scanning stage - nuclei template-based vulnerability detection"""
import logging
import json
from typing import List, Optional, Dict
from datetime import datetime
from pydantic import BaseModel, Field

from ..config import DiscoveryConfig
from ..models import Service, Endpoint, Finding, CVE
from ..tools.runner import ToolRunner

logger = logging.getLogger(__name__)


class VulnerabilityResults(BaseModel):
    """Results from vulnerability scanning stage"""
    findings: List[Finding] = Field(default_factory=list)
    total_scans: int = 0
    vulnerabilities_found: int = 0
    critical_count: int = 0
    high_count: int = 0
    medium_count: int = 0
    low_count: int = 0
    info_count: int = 0


class VulnerabilityScanner:
    """Vulnerability scanning stage - nuclei-powered vulnerability detection"""

    # Default severity levels to scan
    DEFAULT_SEVERITIES = ['critical', 'high', 'medium']

    # Template tags for comprehensive scanning
    DEFAULT_TAGS = [
        'cve',              # CVE-based vulnerabilities
        'exposure',         # Information exposure
        'misconfig',        # Misconfigurations
        'auth-bypass',      # Authentication bypasses
        'sqli',             # SQL injection
        'xss',              # Cross-site scripting
        'lfi',              # Local file inclusion
        'rce',              # Remote code execution
        'ssrf',             # Server-side request forgery
        'redirect',         # Open redirects
        'xxe',              # XML external entity
    ]

    def __init__(self, config: DiscoveryConfig):
        """Initialize vulnerability scanner

        Args:
            config: Discovery configuration
        """
        self.config = config
        self.runner = ToolRunner(timeout=config.nuclei_timeout if hasattr(config, 'nuclei_timeout') else 600)

    async def run(
        self,
        services: List[Service],
        endpoints: List[Endpoint],
        severity: Optional[List[str]] = None,
        tags: Optional[List[str]] = None
    ) -> VulnerabilityResults:
        """Execute vulnerability scanning

        Args:
            services: List of live services to scan
            endpoints: List of endpoints to scan
            severity: Severity levels to include (default: critical, high, medium)
            tags: Template tags to use (default: comprehensive tag set)

        Returns:
            VulnerabilityResults with discovered vulnerabilities
        """
        logger.info(f"Starting vulnerability scanning for {len(services)} services, {len(endpoints)} endpoints")
        results = VulnerabilityResults()

        # Use defaults if not provided
        severity = severity or self.DEFAULT_SEVERITIES
        tags = tags or self.DEFAULT_TAGS

        # Combine service URLs and endpoints
        all_targets = self._prepare_targets(services, endpoints)

        if not all_targets:
            logger.warning("No targets to scan, skipping vulnerability scanning")
            return results

        results.total_scans = len(all_targets)

        try:
            # Run nuclei scanning
            findings = await self._scan_with_nuclei(all_targets, severity, tags)
            results.findings = findings
            results.vulnerabilities_found = len(findings)

            # Count by severity
            for finding in findings:
                sev = finding.severity.value
                if sev == 'critical':
                    results.critical_count += 1
                elif sev == 'high':
                    results.high_count += 1
                elif sev == 'medium':
                    results.medium_count += 1
                elif sev == 'low':
                    results.low_count += 1
                elif sev == 'info':
                    results.info_count += 1

            logger.info(
                f"Vulnerability scanning complete: {results.vulnerabilities_found} findings "
                f"(critical: {results.critical_count}, high: {results.high_count}, "
                f"medium: {results.medium_count})"
            )

        except Exception as e:
            logger.error(f"Vulnerability scanning failed: {e}")
            raise

        return results

    def _prepare_targets(self, services: List[Service], endpoints: List[Endpoint]) -> List[str]:
        """Prepare target URLs for scanning

        Args:
            services: List of services
            endpoints: List of endpoints

        Returns:
            Deduplicated list of target URLs
        """
        targets = set()

        # Add service base URLs
        for service in services:
            targets.add(service.url)

        # Add endpoints (limit to avoid overwhelming nuclei)
        # Prioritize unique paths over query parameters
        unique_paths = set()
        for endpoint in endpoints:
            # Extract base URL without query parameters
            base_url = endpoint.url.split('?')[0]
            if base_url not in unique_paths:
                targets.add(endpoint.url)
                unique_paths.add(base_url)

        logger.debug(f"Prepared {len(targets)} unique targets for scanning")
        return list(targets)

    async def _scan_with_nuclei(
        self,
        targets: List[str],
        severity: List[str],
        tags: List[str]
    ) -> List[Finding]:
        """Scan targets with nuclei

        Args:
            targets: List of URLs to scan
            severity: Severity levels to include
            tags: Template tags to use

        Returns:
            List of Finding objects
        """
        logger.debug(f"Scanning {len(targets)} targets with nuclei")
        findings = []

        try:
            # Run nuclei with tags and severity
            output = await self.runner.run_nuclei(
                targets=targets,
                templates=None,
                tags=tags,  # Pass template tags
                severity=severity,
                timeout=self.config.nuclei_timeout if hasattr(self.config, 'nuclei_timeout') else 600
            )

            # Handle empty output (no vulnerabilities found)
            if not output or not output.strip():
                logger.debug("Nuclei returned no output (no vulnerabilities found)")
                return findings

            # Parse JSONL output
            for line in output.strip().split('\n'):
                if not line or not line.strip():
                    continue

                try:
                    data = json.loads(line)
                    finding = self._parse_nuclei_result(data)

                    if finding:
                        findings.append(finding)

                except json.JSONDecodeError as e:
                    logger.warning(f"Failed to parse nuclei JSON line: {e}")
                    logger.debug(f"Problematic line: {line[:100]}")
                    continue

            logger.debug(f"Parsed {len(findings)} findings from nuclei")

        except Exception as e:
            logger.error(f"Nuclei execution failed: {e}")
            raise

        return findings

    def _parse_nuclei_result(self, data: Dict) -> Optional[Finding]:
        """Parse nuclei JSON result into Finding

        Args:
            data: Nuclei JSON result

        Returns:
            Finding object or None
        """
        try:
            # Extract template info
            template_info = data.get('info', {})
            template_id = data.get('template-id', 'unknown')
            name = template_info.get('name', template_id)
            description = template_info.get('description', '')
            severity = template_info.get('severity', 'info')

            # Extract matched URL
            matched_at = data.get('matched-at') or data.get('host')
            if not matched_at:
                return None

            # Extract CVE references
            cve_refs = []
            classification = template_info.get('classification', {})
            if 'cve-id' in classification:
                cve_ids = classification['cve-id']
                if isinstance(cve_ids, list):
                    for cve_id in cve_ids:
                        cve_refs.append(CVE(id=cve_id, cvss_score=None))
                else:
                    cve_refs.append(CVE(id=cve_ids, cvss_score=None))

            # Extract extracted data
            extracted_data = data.get('extracted-results', [])

            # Extract matcher details
            matcher_name = data.get('matcher-name', '')

            # Build evidence
            evidence = {
                'template_id': template_id,
                'matcher': matcher_name,
                'extracted': extracted_data
            }

            # Extract CWE if available
            cwe = classification.get('cwe-id')

            # Create Finding
            finding = Finding(
                title=name,
                description=description,
                severity=severity,
                url=matched_at,
                evidence=evidence,
                cve_references=cve_refs if cve_refs else None,
                cwe_id=cwe,
                discovered_at=datetime.utcnow(),
                tool='nuclei'
            )

            return finding

        except Exception as e:
            logger.warning(f"Failed to parse nuclei result: {e}")
            return None
